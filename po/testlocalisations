#!/bin/bash

package=xx$(egrep "^DOMAIN" Makevars | sed "s/DOMAIN = //g")xx
potfile=${package}.pot

lang=$(echo $1 |sed "s/\.po$//")
lang=${lang:-de_DE}
export LANGUAGE=../../../../../../../../$(pwd)/mo/$lang:$lang
echo "LANGUAGE=$LANGUAGE"

litedir=lite

if [ $lang == "de_DE" ]; then
	mkdir -p $lang
	./intltool-update --pot --gettext-package=$package
	podebug --rewrite=xxx -f "" --progress=none $potfile $lang.po
	podebug --rewrite=xxx -f "" --ignore=gtk --progress=none $litedir/gtk20.pot $lang/gtk20.po
	podebug --rewrite=xxx -f "" --progress=none $litedir/gtkspell.pot $lang/gtkspell.po
	# Prepare 639 by copying French (which is always 100%), turning it into English
	# and then making it xxx
	msgunfmt /usr/share/locale/fr/LC_MESSAGES/iso_639.mo > $lang/iso_639.fr.po
	podebug --rewrite=en -f "" --progress=none $lang/iso_639.fr.po $lang/iso_639.en.po
	podebug --rewrite=xxx -f "" --progress=none $lang/iso_639.en.po $lang/iso_639.po
	rm $lang/iso_639.*.po
	# Do the same for 3166 as 639
	msgunfmt /usr/share/locale/fr/LC_MESSAGES/iso_3166.mo > $lang/iso_3166.fr.po
	podebug --rewrite=en -f "" --progress=none $lang/iso_3166.fr.po $lang/iso_3166.en.po
	podebug --rewrite=xxx -f "" --progress=none $lang/iso_3166.en.po $lang/iso_3166.po
	rm $lang/iso_3166.*.po
fi
for po in $(ls *.po | egrep -v lite)
do
	language=$(basename $po .po)
	modir=mo/$language/LC_MESSAGES
	gtklite=$language/gtk20.po
	gtkreal=/usr/share/locale/$languagge/LC_MESSAGES/gtk20.mo
	gtkspell=$language/gtkspell.po
	gtkspellreal=/usr/share/locale/$language/LC_MESSAGES/gtkspell.mo
	iso639lite=$language/iso_639.po
	iso639=/usr/share/locale/$language/LC_MESSAGES/iso_639.mo
	iso3166lite=$language/iso_3166.po
	iso3166=/usr/share/locale/$language/LC_MESSAGES/iso_3166.mo
	mkdir -p $modir
	msgfmt -o $modir/virtaal.mo $po
        if [ -f $gtklite ]; then
		msgfmt -o $modir/gtk20.mo $gtklite
	elif [ -f $gtkreal ]; then
		cp $gtkreal $modir
	fi
        if [ -f $gtkspell ]; then
		msgfmt -o $modir/gtkspell.mo $gtkspell
	elif [ -f $gtkspellreal ]; then
		cp $gtkspellreal $modir
	fi
        if [ -f $iso639lite ]; then
		msgfmt -o $modir/iso_639.mo $iso639lite
	elif [ -f $iso639 ]; then
		cp $iso639 $modir
	fi
        if [ -f $iso3166lite ]; then
		msgfmt -o $modir/iso_3166.mo $iso3166lite
	elif [ -f $iso3166 ]; then
		cp $iso3166 $modir
	fi
done

# This assumes that the following executable is in your PATH
virtaal
rm -f $potfile
rm -rf mo de_DE
